import { PMREMGenerator, sRGBEncoding, TextureLoader, WebGLRenderTarget } from "three";
import type { WebGLRenderer } from "three";

const src = 'data:image/png;base64,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';

const envMaps = new WeakMap();

export const loadEnvMap = ( renderer: WebGLRenderer ): Promise<WebGLRenderTarget> => {

	return new Promise( ( resolve ) => {

		const envMap = envMaps.get( renderer );
		if ( envMap && envMap instanceof WebGLRenderTarget ) {

			resolve( envMap );
			return;

		}

		new TextureLoader().load( src, ( equirectangularMap ) => {

			const pmremGenerator = new PMREMGenerator( renderer );
			pmremGenerator.compileEquirectangularShader();
			const envMap = pmremGenerator.fromEquirectangular( equirectangularMap );
			envMap.texture.encoding = sRGBEncoding;
			equirectangularMap.dispose();
			resolve( envMap );
			return;

		} );

	} );

};
